node('covscan') {
    checkout scm
    olm_bundles = load('olm_bundles.groovy')
    olm_bundles.commonlib.describeJob("olm_bundle", """
        <h2>Create bundle images for OLM operators</h2>
        <b>Timing</b>: Run by the ocp4 or custom jobs after new builds.
        Should only need humans to run if something breaks.

        This job creates operator bundle images. These are much like operator
        metadata images in that it contains an operator manifest with a CSV.
        However it only represents a single version of that operator, and only
        ever needs to be built once; there is no need to rebuild for release.
    """)
    bundle_nvrs = []
}

String[] operator_nvrs = []
String[] only = []
String[] exclude = []

pipeline {
    agent { label 'covscan' }

    options {
        disableResume()
        skipDefaultCheckout()
    }

    parameters {
        choice(
            name: 'BUILD_VERSION',
            choices: olm_bundles.commonlib.ocpVersions,
            description: 'OCP Version',
        )
        string(
            name: 'ASSEMBLY',
            description: 'Assembly name.',
            defaultValue: "stream",
            trim: true,
        )
        string(
            name: 'DOOZER_DATA_PATH',
            description: 'ocp-build-data fork to use (e.g. test customizations on your own fork)',
            defaultValue: "https://github.com/openshift/ocp-build-data",
            trim: true,
        )
        string(
            name: 'OPERATOR_NVRS',
            description: '(Optional) List **only** the operator NVRs you want to build bundles for, everything else gets ignored. The operators should not be mode:disabled/wip in ocp-build-data',
            defaultValue: "",
            trim: true,
        )
        string(
            name: 'ONLY',
            description: '(Optional) List **only** the operators you want '  +
                         'to build, everything else gets ignored.\n'         +
                         'Format: Comma and/or space separated list of brew '+
                         'packages (e.g.: cluster-nfd-operator-container)\n' +
                         'Leave empty to build all (except EXCLUDE, if defined)',
            defaultValue: '',
            trim: true,
        )
        string(
            name: 'EXCLUDE',
            description: '(Optional) List the operators you **don\'t** want ' +
                         'to build, everything else gets built.\n'            +
                         'Format: Comma and/or space separated list of brew ' +
                         'packages (e.g.: cluster-nfd-operator-container)\n'  +
                         'Leave empty to build all (or ONLY, if defined)',
            defaultValue: '',
            trim: true,
        )
        booleanParam(
            name: 'FORCE_BUILD',
            description: 'Rebuild bundle containers, even if they already exist for given operator NVRs',
            defaultValue: false,
        )
        booleanParam(
            name: 'DRY_RUN',
            description: 'Just show what would happen, without actually executing the steps',
            defaultValue: false,
        )
        booleanParam(
            name: 'MOCK',
            description: 'Pick up changed job parameters and then exit',
            defaultValue: false,
        )
    }

    stages {
        stage('Check mock') {
            steps {
                script {
                    olm_bundles.commonlib.checkMock()
                }
            }
        }
        stage('Set build info') {
            steps {
                script {
                    operator_nvrs = olm_bundles.commonlib.parseList(params.OPERATOR_NVRS)
                    only = olm_bundles.commonlib.parseList(params.ONLY)
                    exclude = olm_bundles.commonlib.parseList(params.EXCLUDE)
                    currentBuild.displayName += " (${params.BUILD_VERSION})"

                    if (params.ASSEMBLY && params.ASSEMBLY != "stream") {
                        currentBuild.displayName += " - assembly ${params.ASSEMBLY}"
                    }
                    if (operator_nvrs && (only || exclude)) {
                        error("Cannot use OPERATOR_NVRS with ONLY or EXCLUDE.")
                    }
                    olm_bundles.buildlib.initialize(false, false)  // ensure kinit
                }
            }
        }
        stage('Build bundles') {
            steps {
                script {
                    lock("olm_bundle-${params.BUILD_VERSION}") {
                        bundle_nvrs = olm_bundles.build_bundles(only, exclude, operator_nvrs, params.DOOZER_DATA_PATH)
                    }
                    echo "Successfully built:\n${bundle_nvrs.join('\n')}"
                }
            }
        }
    }
    post {
        always {
            script {
                olm_bundles.archiveDoozerArtifacts()
            }
        }
        failure {
            script {
                if (params.DRY_RUN) {
                    return
                }
                olm_bundles.slacklib.to(params.BUILD_VERSION).say("""
                *:heavy_exclamation_mark: olm_bundle failed*
                buildvm job: ${olm_bundles.commonlib.buildURL('console')}
                """)
            }
        }
    }
}
